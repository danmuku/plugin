<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="https://lib.sinaapp.com/js/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="embed.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>测试页面</title>
</head>

<body>
    <h1>这是一个测试页面</h1>
    <div class="danmako_screen">
        <div class="s_dm">
            <div class="mask"></div>
            <div class="s_show"></div>
        </div>
        <div class="send">
            <div class="s_con">
                <input type="text" class="s_txt"/>
                <input type="button" class="s_btn" value="发表评论"/>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">

var urlLocation = location.href;

if(urlLocation.charAt(urlLocation.length - 1) === '#'){
    urlLocation = urlLocation.substr(0, urlLocation.length-1);
}

if(urlLocation.charAt(urlLocation.length - 1) === '/'){
    urlLocation = urlLocation.substr(0, urlLocation.length-1);
}



var firebase;
$.ajaxSetup({cache: true});

// load firebase.js
$.getScript("https://cdn.firebase.com/js/client/2.2.1/firebase.js", function(){
    firebase = new Firebase('https://dazzling-fire-9662.firebaseio.com/'+ window.btoa(urlLocation));
    firebase.on('child_added',
    function (snapshot) {
        var message = snapshot.val();
        console.log(message);
        $(".s_show").append("<div>" + message + "</div>");
        init_screen();
    });

});



//发表评论
$(".s_btn").click(function () {
    post();
});


$(document).keydown(function(event){
    var keyCode = event.keyCode;
    if (keyCode == 13) {
        post();
    }else if(keyCode == 27){
        $(".danmako_screen").toggle(600);
    }
});

function post() {
    var text = $(".s_txt").val();
    if (text) {
        $(".s_txt").val("");
        firebase.push(text);
    } else {
        $(".s_txt").focus();
    }
}




//初始化弹幕
function init_screen() {
    var _top = 0;

    $(".s_show").find("div").show().each(function () {
        var _left = $(window).width() - $(this).width();
        var _height = $(window).height();

        _top = _top + 80;

        if (_top > _height - 100) {
            _top = 80;
        }

        var time = 10000;
        if ($(this).index() % 2 == 0) {
            time = 20000;
        }
        //设定文字的初始化位置
        $(this).css({
            left: _left,
            top: _top,
            color: getRandomColor()
        });
        $(this).animate({
                left: "-" + _left + "px"
            },
            time,
            function () {

            });

    });
}

//随机获取颜色值
function getRandomColor() {
    return '#' + (function (h) {
            return new Array(7 - h.length).join("0") + h
        })((Math.random() * 0x1000000 << 0).toString(16))
}
</script>

</html>